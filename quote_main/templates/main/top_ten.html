{% extends "main/base.html" %}

{% block content %}

<div class="container" style="margin-top: 30px">

  <h1 class="display-6">Топ десять цитат</h1>

  {% for quote in quotes %}
    {% csrf_token %}
    <figure class="text-center bg-light rounded p-3">
      <blockquote class="blockquote">
        <p> "{{ quote.quote }}" </p>
      </blockquote>
      <figcaption class="blockquote-footer">
        {{ quote.get_type_display }}: "{{ quote.source }}", {{ quote.author }}
        <div class="text-end" role="group">
          <button data-quote-id="{{ quote.id }}" data-vote-type="like" class="btn"><span id="likes-{{ quote.id }}" >{{ quote.likes }}</span> Нравится</button>
          <button data-quote-id="{{ quote.id }}" data-vote-type="dislike" class="btn"><span id="dislikes-{{ quote.id }}">{{ quote.dislikes }}</span> Не нравится</button>
        </div>
        <p class="text-end px-3">Просмотров: {{ quote.views }}</p>
      </figcaption>
    </figure>
  {% endfor %}

</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
        const voteButtons = document.querySelectorAll('button[data-quote-id]');
  
        voteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const quoteId = this.getAttribute('data-quote-id');
                const voteType = this.getAttribute('data-vote-type');
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
                fetch('{% url "quote_main:like_dislike_proc" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'quote_id': quoteId,
                        'vote_type': voteType
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Если голос зафиксирован, обновляем счетчики на странице
                        const likesSpan = document.getElementById(`likes-${quoteId}`);
                        const dislikesSpan = document.getElementById(`dislikes-${quoteId}`);
  
                        likesSpan.textContent = data.likes;
                        dislikesSpan.textContent = data.dislikes;
  
                    } else {
                        alert(data.message); // Показываем сообщение об ошибке
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>
{% endblock %}